{"title":"Hexo + GitHub Action 自动化博客部署","date":"2023-11-19T00:00:00.000Z","date_formatted":{"ll":"Nov 19, 2023","L":"11/19/2023","MM-DD":"11-19"},"thumbnail":"https://blog-1251959181.cos.accelerate.myqcloud.com/cover/github-actions.png","link":"2023/11/18/oc_hexo_inside_deploy","comments":true,"tags":["Original Content"],"categories":["Coding"],"updated":"2024-07-01T17:57:02.538Z","content":"<!-- - Inside@2.7.0\n- Hexo@6.3.0\n- Github Page\n- Github Action\n- Git-X-modules -->\n<!-- > 装依赖真的是一件非常令人头疼的事 -->\n<hr>\n<p>Hexo 官方目前给出的自动化部署方案是将博客仓库部署到 Github Page，使用一个仓库，但这样就需要把博客源码开源，为了避免这个问题，我还是使用两个仓库的方式，将博客源码保存在自己的私人仓库，使用 GitHub Action 部署。</p>\n<h2 id=\"准备工作\">准备工作<a title=\"#准备工作\" href=\"#准备工作\"></a></h2>\n<!-- 开始之前需要准备两个仓库：博客源代码仓库`hexoblog`，和展示仓库 GitHub Pages，相关的初始化不在这里赘述。 -->\n<p>我们假设博客源代码文件夹名为<code>hexoblog</code>，目录结构如下：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- /hexoblog</span><br><span class=\"line\">  - /public    编译生成的静态资源</span><br><span class=\"line\">  - /source</span><br><span class=\"line\">    - /_drafts   草稿</span><br><span class=\"line\">    - /_posts    文章</span><br><span class=\"line\">  - /themes    主题</span><br><span class=\"line\">  - _config.yml 配置文件</span><br><span class=\"line\">  - .gitignore</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>首先在本地部署，我使用 Inside 主题最高支持 Hexo@6.3.0，调试成功以后使用<code>hexo-deploy-git</code>插件部署到 GitHub Page，这一步跑通以后就可以进行自动化改造了。</p>\n</blockquote>\n<h2 id=\"gitignore\">gitignore<a title=\"#gitignore\" href=\"#gitignore\"></a></h2>\n<p>确保在<code>.gitignore</code>文件中包含以下内容：</p>\n<ul>\n<li><code>node_modules/</code>: 工作流中会重新安装依赖，与本地环境可能不同</li>\n<li><code>public/</code>: 博客生成的静态文件，无需上传</li>\n<li><code>.deploy_git</code>: 本地直接部署时会生成该文件夹，忽略以避免冲突</li>\n</ul>\n<h2 id=\"personal-access-token\">personal access token<a title=\"#personal-access-token\" href=\"#personal-access-token\"></a></h2>\n<p>在工作流的虚拟机中向 GitHub Pages 推送代码，需要配置 <a href=\"https://docs.github.com/zh/authentication/keeping-your-account-and-data-secure/managing-your-personal-access-tokens\" target=\"_blank\">PAT</a> 进行鉴权（将密码明文存储在仓库中并不安全且 Github 已经弃用密码登录方式）</p>\n<p>在<code>个人账户</code>-&gt;<code>Settings</code>-&gt;<code>Developer settings</code>-&gt;<code>Personal access tokens</code>生成密钥</p>\n<p>GitHub 正在推出新的更细粒度的鉴权 token，但个人建议使用传统（classic）密钥，确保密钥有对足够权限</p>\n<p>复制密钥文本，添加到博客源码仓库<code>hexoblog</code>-&gt;<code>Settings</code>-&gt;<code>Secrets and variables</code>-&gt;<code>Actions</code>-&gt;<code>New repository secret</code></p>\n<h2 id=\"workflow\">workflow<a title=\"#workflow\" href=\"#workflow\"></a></h2>\n<p>在源码仓库中编写工作流脚本，完整内容如下：</p>\n<figure class=\"highlight yml\"><figcaption><span>.github/workflows/deploy.yml</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">name:</span> <span class=\"string\">Page</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">on:</span></span><br><span class=\"line\">  <span class=\"attr\">push:</span></span><br><span class=\"line\">    <span class=\"attr\">branches:</span> [<span class=\"string\">master</span>]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">jobs:</span></span><br><span class=\"line\">  <span class=\"attr\">build:</span></span><br><span class=\"line\">    <span class=\"attr\">runs-on:</span> <span class=\"string\">ubuntu-latest</span></span><br><span class=\"line\">    <span class=\"attr\">steps:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">Checkout</span></span><br><span class=\"line\">        <span class=\"attr\">uses:</span> <span class=\"string\">actions/checkout@v3</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">Use</span> <span class=\"string\">Node.js</span> <span class=\"number\">16.</span><span class=\"string\">x</span></span><br><span class=\"line\">        <span class=\"attr\">uses:</span> <span class=\"string\">actions/setup-node@v2</span></span><br><span class=\"line\">        <span class=\"attr\">with:</span></span><br><span class=\"line\">            <span class=\"attr\">node-version:</span> <span class=\"string\">&#x27;16&#x27;</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">Cache</span> <span class=\"string\">NPM</span> <span class=\"string\">dependencies</span></span><br><span class=\"line\">        <span class=\"attr\">uses:</span> <span class=\"string\">actions/cache@v2</span></span><br><span class=\"line\">        <span class=\"attr\">with:</span></span><br><span class=\"line\">          <span class=\"attr\">path:</span> <span class=\"string\">node_modules</span></span><br><span class=\"line\">          <span class=\"attr\">key:</span> <span class=\"string\">$&#123;&#123;</span> <span class=\"string\">runner.OS</span> <span class=\"string\">&#125;&#125;-npm-cache</span></span><br><span class=\"line\">          <span class=\"attr\">restore-keys:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">            $&#123;&#123; runner.OS &#125;&#125;-npm-cache</span></span><br><span class=\"line\"><span class=\"string\"></span>      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">Install</span> <span class=\"string\">Dependencies</span></span><br><span class=\"line\">        <span class=\"attr\">run:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">          npm install hexo@6.3.0</span></span><br><span class=\"line\"><span class=\"string\">          cd themes/inside</span></span><br><span class=\"line\"><span class=\"string\">          npm install</span></span><br><span class=\"line\"><span class=\"string\">          cd ../..</span></span><br><span class=\"line\"><span class=\"string\">          npm install</span></span><br><span class=\"line\"><span class=\"string\"></span>      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">Setup</span> <span class=\"string\">Credentials</span></span><br><span class=\"line\">        <span class=\"attr\">run:</span> <span class=\"string\">git</span> <span class=\"string\">config</span> <span class=\"string\">--global</span> <span class=\"string\">url.https://$&#123;&#123;</span> <span class=\"string\">secrets.YOUR_DEPLOY_KEY</span> <span class=\"string\">&#125;&#125;@github.com/.insteadOf</span> <span class=\"string\">https://github.com/</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">Deploy</span> <span class=\"string\">to</span> <span class=\"string\">GitHub</span> <span class=\"string\">Pages</span></span><br><span class=\"line\">        <span class=\"attr\">run:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">          git config --global user.name &quot;Your GitHub Username&quot;</span></span><br><span class=\"line\"><span class=\"string\">          git config --global user.email &quot;your-email@example.com&quot;</span></span><br><span class=\"line\"><span class=\"string\">          npx hexo deploy</span></span><br></pre></td></tr></table></figure>\n<p>代码解释：</p>\n<ol>\n<li><code>Checkout</code>: 将本仓库（hexoblog）代码克隆到运行工作流的虚拟机上</li>\n<li><code>Use Node.js 16.x</code>: 配置 Node.js 环境，指定使用 Node.js 的 16.x 版本</li>\n<li><code>Cache NPM dependencies</code>: 缓存项目的 node_modules 目录，加速后续运行中的依赖安装过程</li>\n<li><code>Install Dependencies</code>: 全局安装指定版本的 Hexo（6.3.0），然后安装主题依赖</li>\n<li><code>Setup Credentials</code>: 使用 PAT 代替密码进行鉴权（一个临时的方案）</li>\n<li><code>Deploy to GitHub Pages</code>: 配置用户名和邮箱地址，将代码部署到 GitHub Pages</li>\n</ol>\n<h2 id=\"bugfix\">bugfix<a title=\"#bugfix\" href=\"#bugfix\"></a></h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">fatal: could not read Username for &#x27;https://github.com&#x27;: No such device or address`</span><br></pre></td></tr></table></figure>\n<p>PAT 未正确设置（虽然 GitHub Action 内置了通用 token：$，但并不能用于此处）</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">fatal: Authentication failed for &#x27;https://github.com/vincenteliang/vincenteliang.github.io.git/&#x27;`</span><br></pre></td></tr></table></figure>\n<p>没有配置上面第 5 步</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git@github.com: Permission denied (publickey).</span><br><span class=\"line\">fatal: Could not read from remote repository.</span><br><span class=\"line\"></span><br><span class=\"line\">Please make sure you have the correct access rights</span><br><span class=\"line\">and the repository exists.</span><br></pre></td></tr></table></figure>\n<p>在配置文件<code>_config.yml</code>中需要以<code>https://</code>的形式指定 GitHub Page 仓库地址，如使用<code>git@github</code>的形式会进行 SSH 鉴权，导致失败</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">fatal: empty ident name (for &lt;runner@xxx.xxx.xxx.internal.cloudapp.net&gt;) not allowed</span><br></pre></td></tr></table></figure>\n<p>未指定用户名和邮箱</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">fatal: No url found for submodule path &#x27;.deploy_git&#x27; in .gitmodules</span><br><span class=\"line\"></span><br><span class=\"line\">fatal: detected dubious ownership in repository at &#x27;/github/workspace/.deploy_git&#x27;</span><br></pre></td></tr></table></figure>\n<p>上传了多余的<code>.deploy_git</code>文件夹，手动删除重新 push 并将其添加到<code>.gitignore</code>中</p>\n","prev":{"title":"Llama 2 本地部署指南","link":"2023/11/23/oc_run_llama2_local"},"next":{"title":"新时代中国特色社会主义理论与实践","link":"2023/11/14/ustb_gs_newEra"},"plink":"https://vincenteliang.com/2023/11/18/oc_hexo_inside_deploy/","toc":[{"id":"准备工作","title":"准备工作","index":"1"},{"id":"gitignore","title":"gitignore","index":"2"},{"id":"personal-access-token","title":"personal access token","index":"3"},{"id":"workflow","title":"workflow","index":"4"},{"id":"bugfix","title":"bugfix","index":"5"}],"reward":true,"copyright":{"author":"Vincente Liang","link":"<a href=\"https://vincenteliang.com/2023/11/18/oc_hexo_inside_deploy/\" title=\"Hexo + GitHub Action 自动化博客部署\">https://vincenteliang.com/2023/11/18/oc_hexo_inside_deploy/</a>","license":"Attribution-NonCommercial-NoDerivatives 4.0 International (<a href=\\\"https://creativecommons.org/licenses/by-nc-sa/4.0/\\\" rel=\\\"external nofollow\\\" target=\\\"_blank\\\">CC BY-NC-ND 4.0</a>)","published":"November 19, 2023","updated":"July 1, 2024"},"reading_time":"933 words in 6 min"}